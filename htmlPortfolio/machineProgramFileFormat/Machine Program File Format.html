<!DOCTYPE html>
<html>

<head>
	<title>Machine Program File Name</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href='./MPFFstylesheet.css' rel='stylesheet'>
	<script type='module'>
		
		/*----------------
			 General Inputs
			----------------*/
		
		// Setup features shared by all of the inputs
		const inputs = document.querySelectorAll('input');
		inputs.forEach((input, i) => {
			// Setup using Enter to traverse through the fields
			input.addEventListener('keydown', function() {
				if (event.key == 'Enter') {
					if (i == 6 && !event.shiftKey) {	// Machine Number(s) field exception, for Shift + Enter
						addMN(this.value);
						this.value = '';
					}
					else if (i < inputs.length - 1) {	// Non-exception fields focus on the next input
						inputs[i + 1].focus();
					}
					else {	// Last field, Notes, generates the file name
						this.blur();
						genName();
					}
				}
			});
			// Setup removal of .empty classes
			input.addEventListener('blur', function() {
				if (this.value) {	// Removes .empty class if the input was filled
					input.classList.remove('empty');
				}
				else if (i == 6) {	// Returns Machine Number input's placeholder, incase it was changed
					inputs[6].setAttribute('placeholder', 'Enter One at a Time');
				}
			});
		});
		
		// Focuses the first input on page load
		inputs[0].focus();
		
		/*------
			 Date
			------*/
		
		const date = document.getElementById('date');
		// If the bar is clicked, but not a specific input, focuses on the month
		date.addEventListener('click', function() {
			if (document.activeElement != dd && document.activeElement != yy) {
				mm.focus();
			}
		});
		
		const datePs = date.querySelectorAll('p');
		const dateInputs = date.querySelectorAll('input');
		// Event listeners shared between the date inputs
		dateInputs.forEach((input, i) => {
			// Sets up the navigation and key rules
			input.addEventListener('keydown', function() {
					const allowedKeys = [
						'Tab',
						'Backspace',
						'Enter'
				];
				const isDigit = /\d/.test(event.key);
				const isFunctionKey = event.key.startsWith('F') && parseInt(event.key.substring(1)) >= 1 && parseInt(event.key.substring(1)) <= 12;
				const isAllowedSpecialKey = allowedKeys.includes(event.key);
				if (!isDigit && !isFunctionKey && !isAllowedSpecialKey) {	// Prevents letters and special characters
						event.preventDefault();
				}
				if (event.key == 'Delete') {	// Delete removes all chars from the input
					this.value = '';
				}
				else if (event.key == 'Backspace' && this.value < 10) {	// Backspace removes one char and reformats input
					event.preventDefault();
					this.value = '';
					if (i) {
						dateInputs[i - 1].focus();
					}
				}
				else if (event.key == 'ArrowLeft' && i) { // Left Arrow moves between the inputs
					dateInputs[i - 1].focus();
				}
				else if (event.key == 'ArrowRight' && i != 2) {	// Right Arrow moves between the inputs
					dateInputs[i + 1].focus();
				}
			});
			// Sets up changing colors when bluring any of the inputs
			input.addEventListener('blur', function() {
				if (!(mm.value && dd.value && yy.value)) {	// Returns slashes to placeholder color, until all inputs have values
					datePs[0].style.color = '#ccc';
					datePs[1].style.color = '#ccc';
				}
				else {	// Removes the empty class, when all inputs have values
					date.classList.remove('empty');
				}
			});
			// Sets up changing colors when focusing any of the inputs
			input.addEventListener('focus', function() {
				datePs[0].style.color = '#666';
				datePs[1].style.color = '#666';
			});
		});
		// Calls formatMonth when the mm input is changed
		const mm = document.getElementById('mm');
		mm.addEventListener('input', function() {
			formatMonth();
		});
		// Calls formatDay when the dd input is changed
		const dd = document.getElementById('dd');
		dd.addEventListener('input', function() {
			formatDay();
		});
		// Calls formatYear when the yy input is changed
		const yy = document.getElementById('yy');
		yy.addEventListener('input', function() {
			formatYear();
		});
		
		// Adjusts the formatting of the month input
		function formatMonth() {
			var leadingZero = false;
			if (mm.value.toString().includes('00')) {	// Checks if 0 was last input
				var leadingZero = true;
			}
			var value = mm.value.toString().replace(/^0+/, '');
			if (value == 0) {	// Adds leading zero
				mm.value = '00';
			}
			else if (value < 10) {	// One digit, adds leading zero
				mm.value = '0' + value;
			}
			else {	// Two digits, set value
				mm.value = value;
			}
			if (value > 12) {	// Return to possible month
				mm.value = 12;
			}
			if (value > 1 || (leadingZero && value > 0)) {	// Full value entered, navigate to next input
				dd.focus();
			}
		}
		
		// Adjusts the formatting of the day input
		function formatDay() {
			var leadingZero = false;
			if (dd.value.toString().includes('00')) {	// Checks if 0 was last input
				var leadingZero = true;
			}
			var value = dd.value.toString().replace(/^0+/, '');
			if (value == 0) {	// Adds leading zero
				dd.value = '00';
			}
			else if (value < 10) {	// One digit, adds leading zero
				dd.value = '0' + value;
			}
			else {	// Two digits, set value
				dd.value = value;
			}
			if (value > 31) {	// Return to possible day
				dd.value = 31;
			}
			if (value > 3 || (leadingZero && value > 0)) {	// Full value entered, navigate to next input
				yy.focus();
			}
		}
		
		// Adjusts the formatting of the year input
		function formatYear() {
			var leadingZero = false;
			if (yy.value.toString().includes('00')) {	// Checks if 0 was last input
				var leadingZero = true;
			}
			var value = yy.value.toString().replace(/^0+/, '');
			if (value == 0) {	// Adds leading zeros
				yy.value = '00';
			}
			else if (value < 10) {	// One digit, adds three leading zeros
				yy.value = '0' + value;
			}
			else if (value < 100) {	// Two digits, adds two leading zeros
				yy.value = '' + value;
			}
			else if (value < 1000) {	// Three digits, adds one leading zero
				yy.value = '' + value;
			}
			else {	// Four digits, set value
				yy.value = value;
			}
			if (value > 99) {	// Return value if it is too high
				yy.value = yy.value.slice(1);
			}
		}
		
		/*----------------
			 Machine Number
			----------------*/
		
		// Adds a machine number
		function addMN(mn) {
			if (mn === '') {	// Returns if the input is empty
				return;
			}
			// Removes the empty class, when all inputs have values
			inputs[6].classList.remove('empty');
			inputs[6].setAttribute('placeholder', 'Shift + Enter to Navigate');
			
			// Checks if the machine number is already in the list
			let ps = document.getElementById('machineNumbers').querySelectorAll('p');
			let queries = Array.from(ps).map(p => p.textContent.toLowerCase());
			if (queries.includes(mn.toLowerCase())) {	// Returns if it is already present
				return;
			}
			
			// Creates the X button
			const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
			path.setAttribute('d', 'M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z');
			const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
			svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
			svg.setAttribute('viewBox', '0 0 24 24');
			svg.appendChild(path);
			const button = document.createElement('button');
			button.setAttribute('type', 'button');
			button.appendChild(svg);
			
			// Creates and sets the text
			const p = document.createElement('p');
			p.classList.add('unselectableText');
			p.textContent = mn;
			
			// Creates the background bubble
			const machineNumber = document.createElement('div');
			machineNumber.classList.add('machineNumber');
			machineNumber.appendChild(p);
			machineNumber.appendChild(button);
			const machineNumberWrapper = document.createElement('div');
			machineNumberWrapper.classList.add('machineNumberWrapper');
			machineNumberWrapper.appendChild(machineNumber);
			
			// Appends to the machine number div
			document.getElementById('machineNumbers').appendChild(machineNumberWrapper);
			
			// Adds event listener for the button click
			machineNumberWrapper.addEventListener('click', function() {
				removeMN(event.currentTarget, true);
			});
		}
		
		// Removes the given machine number
		function removeMN(machineNumberWrapper) {
			if (machineNumberWrapper) {	// Checks that the machine exists before removing
				machineNumberWrapper.remove();
			}
		}
		
		/*---------
			 Buttons
			---------*/
		
		// Listener for the clear button
		const clear = document.getElementById('cButton');
		clear.addEventListener('click', clearFields);
		
		// Clears all of the inputs and resets the result
		function clearFields() {
			clear.blur();
			
			// Clears every input and removes the empty class
			inputs.forEach(input => {
				input.value = '';
				input.classList.remove('empty');
			});
			date.classList.remove('empty');
			
			// Removes the entered machine numbers
			const machineNumberWrappers = document.getElementById('machineNumbers').querySelectorAll(':scope > div');
			for (let i = 0; i < machineNumberWrappers.length; ++i) {
				removeMN(machineNumberWrappers[i]);
			}
			
			// Clears the result, whether it was the name or error message
			result.textContent = '';
			document.getElementById('resultWrapper').style.display = 'none';
			errorWrapper.style.display = 'none';
		}
		
		// Listener for the generate button
		const enter = document.getElementById('eButton');
		enter.addEventListener('click', genName);
		
		// Variables for the results, error message, and generated file name
		const result = document.getElementById('result');
		const errorWrapper = document.getElementById('errorWrapper');
		var fileName = '';
		
		// Generates and displays the file name or displays an error message
		function genName() {
			enter.blur();
			
			// Removes previous results
			const resultWrapper = document.getElementById('resultWrapper');
			resultWrapper.style.display = 'none';
			errorWrapper.style.display = 'none';
			
			// Reading required fields
			const pn = inputs[0].value.trim().toUpperCase();
			const cr = inputs[1].value.trim().toUpperCase().replace(/REV[- _]*/, '');
			const month = mm.value;
			const day = dd.value;
			const year = yy.value;
			const op = inputs[5].value.trim().toUpperCase().replace(/OP[- _]*/, '');
			
			const ps = document.getElementById('machineNumbers').querySelectorAll('p');
			const mns = Array.from(ps).map(p => p.textContent.trim().toUpperCase());
			const mn = inputs[6].value.trim().toUpperCase()
			if (mn != '') {
				mns.push(mn);
			}
			mns.sort();
			
			// Checking required fields
			var missing = 0;
			var mnsError = '';
			if (!pn) {
				++missing;
				inputs[0].classList.add('empty');
			}
			if (!cr) {
				++missing;
				inputs[1].classList.add('empty');
			}
			if (!(month && day && year)) {
				++missing;
				date.classList.add('empty');
			}
			if (!op) {
				++missing;
				inputs[5].classList.add('empty');
			}
			if (!mns.length) {
				++missing;
				inputs[6].classList.add('empty');
				if (inputs[6].value) {	// Displays special error message of machine number input has data, but was not entered
					mnsError = '<br>Press Enter in Machine Number(s) to add a number.';
				}
			}
			
			// Generates and displays the error message regarding incomplete fields
			if (missing) {
				const p = errorWrapper.querySelector('p');
				var error = missing + ' Required Field';
				if (missing == 1) {
					error = error + ' is ';
				}
				else {
					error = error + 's are ';
				}
				error = error + 'Incomplete.';
				p.innerHTML = error + mnsError;
				errorWrapper.style.display = 'flex';
				return;
			}
			
			// Reading optional fields
			const md = document.getElementById('md').value.trim().toUpperCase();
			const ns = document.getElementById('ns').value.trim().toUpperCase();
			
			// Generating the file name
			fileName = pn + ' REV_' + cr + ' V_' + month + '-' + day + '-' + year + ' OP_' + op + ' [';
			mns.forEach((mn, i) => {
				fileName = fileName + mn;
				if (i < mns.length - 1) {
					fileName = fileName + ',';
				}
			});
			fileName = fileName + ']';
			
			if (md) {
				fileName = fileName + ' ' + md;
			}
			if (ns) {
				fileName = fileName + ' (' + ns + ')';
			}
			
			// Displays the file name as the result and the copy to clipboard button
			result.textContent = fileName;
			resultWrapper.style.display = 'flex';
		}
		
		/*-----------
			 Clipboard
			-----------*/
		
		// Listeners for the text of the result
		result.addEventListener('click', saveToClipboard);
		result.addEventListener('mouseleave', revertToolTip);
		
		// Listeners for the copy to clipboard button
		const copyButton = document.getElementById('copy');
		copyButton.addEventListener('click', saveToClipboard);
		copyButton.addEventListener('mouseleave', revertToolTip);
		
		// Copies file name to clipboard and changes the tooltip text
		const toolTip = document.getElementById('toolTip');
		function saveToClipboard() {
			setClipboard(fileName);
			toolTip.textContent = 'Saved to Clipboard';
		}
		
		// Reverts the tooltip text
		function revertToolTip() {
			copyButton.blur();
			toolTip.textContent = 'Copy to Clipboard';
		}
		
		// Copies the text to the user's clipboard
		async function setClipboard(text) {			
			const type = "text/plain";
			const clipboardItemData = {
				[type]: text,
			};
			const clipboardItem = new ClipboardItem(clipboardItemData);
			await navigator.clipboard.write([clipboardItem]);
		}
	</script>
</head>

<body>
	<div class='container'>
		<div class='form'>
			<div class='title'>
				<img src='./1.875INLogoNoTag.jpg' alt='Bradhart Logo' width='251' height='71' draggable='false'>
				<h1>Machine Program File Format</h1> 
			</div>
			<div class='inputsWrapper' id='inputsWrapper'>
				<div>
					<p>Part Number:</p>
					<input id='pn' type='text' placeholder='Exact Format on Work Order'/>
				</div>
				<div>
					<p>Customer Revision:</p>
					<input id='cr' type='text' placeholder='Letters or Numbers Only'/>
				</div>
				<div>
					<p>BPI Print Version Date:</p>
					<div id='date' class='date'>
						<input id='mm' type='number' pattern='[0-9]{2}' min="1" max="12" placeholder='mm'/>
						<p>/</p>
						<input id='dd' type='number' pattern='[0-9]{2}' min="1" max="31" placeholder='dd'/>
						<p>/</p>
						<input id='yy' type='number' pattern='[0-9]{4}' min="0" max="99" placeholder='yy'/>
					</div>
				</div>
				<div>
					<p>Operation:</p>
					<input id='op' type='text' placeholder='10, 20, 30...'/>
				</div>
				<div>
					<p>Machine Number(s):</p>
					<input id='mn' type='text' placeholder='One at a Time, Input MN, Press Enter'/>
				</div>
				<div class='machineNumbers' id='machineNumbers'>
							
				</div>
				<div>
					<p>Multi-Channel Machine Designation:</p>
					<input id='md' type='text' placeholder='(Optional) HD1, HD2...'></input>
				</div>
				<div>
					<p>Notes:</p>
					<input id='ns' type='text' placeholder='(Optional)'></input>
				</div>
			</div>
			<div class='buttonsWrapper'>
				<button id='cButton' class='cButton'>Clear</button>
				<button id='eButton' class='eButton'>Generate</button>
			</div>
			<div id='resultWrapper' class='resultWrapper'>
				<p id='result' class='unselectableText'></p>
				<button id='copy'>
					<i class='fa'>&#xf0ea;</i>
					<span id='toolTip' class='toolTip'>Copy to Clipboard</span>
				</button>
			</div>
			<div id='errorWrapper' class='errorWrapper'>
				<p></p>
			</div>
		</div>
	</div>

</body>
</html>